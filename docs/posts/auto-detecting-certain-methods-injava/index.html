<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Auto-Detecting Certain Methods in Java</title><link href="https://fonts.googleapis.com/css?family=Crimson+Pro:400,400i,700|Eczar:700|Source+Code+Pro:400,400i&display=swap" rel="stylesheet"><link href="/style.css" rel="stylesheet"> <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#bf616a"><meta name="msapplication-TileColor" content="#bf616a"><meta name="theme-color" content="#bf616a"> <meta property="og:title" content="Auto-Detecting Certain Methods in Java"/><meta property="og:url" content="http://blog.hamaluik.ca/posts/auto-detecting-certain-methods-injava/"/><meta property="og:image" content="https://og-image.now.sh/Auto-Detecting%20Certain%20Methods%20in%20Java.png?theme=light&md=0&fontSize=75px&images=https%3A%2F%2Fassets.zeit.co%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fhyper-color-logo.svg&widths=350&heights=350"/><meta property="og:description" content="&lt;p&gt;Although I still have reservations about using Java for publishing large projects (I find these inevitably become slow and clunky due to the JVM), Java is great from a programming standpoint. One thing I especially love about Java is the ability to do run-time “reflections” which allow you to hook into all the loaded classes at run time and do all kinds of crazy things. Combine this with custom Java annotations, and you get a very easy way to write a scriptable interface for a program for example.&lt;&#x2F;p&gt; "/><meta property="og:type" content="article"/><meta property="og:locale" content="en_CA"/><meta property="og:site_name" content="Kenton Hamaluik"/><meta property="article:published_time" content=" 2012-04-02T07:00:00+00:00 "/><meta property="article:author" content="http://blog.hamaluik.ca/kenton/"/> <meta property="article:tag" content="Java"/> <meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="Auto-Detecting Certain Methods in Java"> </head><body><header><h1><a href="/">Kenton Hamaluik</a></h1></header><article><header><h1>Auto-Detecting Certain Methods in Java <time datetime='2012-04-02T07:00:00+00:00'>(2012-04-02)</time></h1></header><p>Although I still have reservations about using Java for publishing large projects (I find these inevitably become slow and clunky due to the JVM), Java is great from a programming standpoint. One thing I especially love about Java is the ability to do run-time “reflections” which allow you to hook into all the loaded classes at run time and do all kinds of crazy things. Combine this with custom Java annotations, and you get a very easy way to write a scriptable interface for a program for example.</p><p>This is exactly what I needed / wanted for a project I’m currently working on—I want the user to be able to call certain internal java functions at will through a console or script. One way you might do this is to write an interface that takes all the functions you want the user to be able to access, keeps them in a mapped list, then when the user calls a function do a lookup an call the method a certain command is linked to. As it turns out, this is long, boring, and can be especially cumbersome when I want to add a new function: I would have to go back into that mapping for each function I add an add a call definition. What I want is just to mark each function as I write is as “scriptable” and let my program take care of the scripting business from there. If you don’t get what I mean, here is an example function that will be auto-detected by my code, and will be callable by the user (<strong>all</strong> I would have to include is the following!):</p><div class="highlight"><pre><span></span><span class="nd">@ScriptInfo</span><span class="p">(</span><span class="n">alias</span> <span class="o">=</span> <span class="s">&quot;quit&quot;</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">description</span> <span class="o">=</span> <span class="s">&quot;exits the game&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">quit</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Game</span><span class="p">.</span><span class="na">quit</span><span class="p">();</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div><p>Here, the <code>@ScriptInfo</code> bit is our marker for the function. <code>args</code> will describe the argument names (since Java reflection can only get argument types, not their names), and <code>description</code> is a short description of the function for when the user calls for help about the function.</p><p>In order to get this up and running then, we first need a list of all classes that are in our classpath that match our package. This can be easily done with the following code:</p><div class="highlight"><pre><span></span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;rawtypes&quot;</span><span class="p">)</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="n">Class</span><span class="o">[]</span> <span class="nf">getClasses</span><span class="p">(</span><span class="n">String</span> <span class="n">packageName</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">ClassNotFoundException</span><span class="p">,</span> <span class="n">IOException</span> <span class="p">{</span>
    <span class="n">ClassLoader</span> <span class="n">classLoader</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">getContextClassLoader</span><span class="p">();</span>
    <span class="k">assert</span> <span class="n">classLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">packageName</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
    <span class="n">Enumeration</span> <span class="n">resources</span> <span class="o">=</span> <span class="n">classLoader</span><span class="p">.</span><span class="na">getResources</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
    <span class="n">List</span> <span class="n">dirs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">resources</span><span class="p">.</span><span class="na">hasMoreElements</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">URL</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">resources</span><span class="p">.</span><span class="na">nextElement</span><span class="p">();</span>
        <span class="n">dirs</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="na">getFile</span><span class="p">()));</span>
    <span class="p">}</span>
    <span class="n">ArrayList</span> <span class="n">classes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">File</span> <span class="n">directory</span> <span class="p">:</span> <span class="n">dirs</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">classes</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">findClasses</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">packageName</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">classes</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="n">classes</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="o">]</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;rawtypes&quot;</span><span class="p">)</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span> <span class="nf">findClasses</span><span class="p">(</span><span class="n">File</span> <span class="n">directory</span><span class="p">,</span> <span class="n">String</span> <span class="n">packageName</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">ClassNotFoundException</span> <span class="p">{</span>
    <span class="n">List</span> <span class="n">classes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">directory</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">classes</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">File</span><span class="o">[]</span> <span class="n">files</span> <span class="o">=</span> <span class="n">directory</span><span class="p">.</span><span class="na">listFiles</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">File</span> <span class="n">file</span> <span class="p">:</span> <span class="n">files</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">isDirectory</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">assert</span> <span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
            <span class="n">classes</span><span class="p">.</span><span class="na">addAll</span><span class="p">(</span><span class="n">findClasses</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">packageName</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">file</span><span class="p">.</span><span class="na">getName</span><span class="p">()));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">endsWith</span><span class="p">(</span><span class="s">&quot;.class&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">classes</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">packageName</span> <span class="o">+</span> <span class="sc">&#39;.&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">classes</span><span class="p">;</span>
<span class="p">}</span>
</pre></div><p>Once we have a list of all classes in our package, we need to filter them based on whether they inherit our <code>Scriptable</code> class. We could skip this and just search through all classes, but I want all of my user-callable methods to have access to a <code>println</code> function which will (somewhat obviously) print data out to the console. This <code>println</code> function lives in a higher class called <code>Scriptable</code>, then all classes which contain user-callable methods can simply extend the <code>Scriptable</code> class and have access to the <code>println</code> function. This filtering is very simple to do:</p><div class="highlight"><pre><span></span><span class="c1">// get all classes in our desired package</span>
<span class="n">Class</span><span class="o">[]</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">getClasses</span><span class="p">(</span><span class="s">&quot;your.package.here&quot;</span><span class="p">);</span>
<span class="c1">// check out our classes</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">classes</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// see if it&#39;s scriptable</span>
    <span class="c1">// make sure it isn&#39;t the &quot;Scriptable&quot; class itself</span>
    <span class="c1">// then make sure that it inherits from the &quot;Scriptable&quot; class</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">classes</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">getSimpleName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;Scriptable&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">Scriptable</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">isAssignableFrom</span><span class="p">(</span><span class="n">classes</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// yup, we found a scriptable class!</span>
        <span class="c1">// now go through and register all methods in the class marked as callable methods</span>
        <span class="n">registerCommands</span><span class="p">(</span><span class="n">classes</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>Now that we have filtered our list of classes, we call <code>registerCommands()</code> on each class. <code>registerCommands()</code> is a function which explores a given class and searches through all of it’s methods for methods that have been marked by us as user-callable. We do this by iterating over the run-time annotations that each method has, and if we found our annotation then we store that method. The following code which does this is fairly well-documented, and should be easy to follow along with:</p><div class="highlight"><pre><span></span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;rawtypes&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerCommands</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// loop over all the methods in the class</span>
    <span class="n">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="na">getMethods</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">methods</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// get the method&#39;s annotations</span>
        <span class="n">Annotation</span><span class="o">[]</span> <span class="n">annotations</span> <span class="o">=</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">getAnnotations</span><span class="p">();</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">annotations</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">annotations</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="k">instanceof</span> <span class="n">ScriptInfo</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// we found our annotation</span>
                <span class="n">ScriptInfo</span> <span class="n">si</span> <span class="o">=</span> <span class="p">(</span><span class="n">ScriptInfo</span><span class="p">)</span><span class="n">annotations</span><span class="o">[</span><span class="n">j</span><span class="o">]</span><span class="p">;</span>
 
                <span class="c1">// create the command name</span>
                <span class="n">String</span> <span class="n">commandName</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="na">alias</span><span class="p">();</span>
                <span class="c1">// get the command args</span>
                <span class="n">Class</span><span class="o">[]</span> <span class="n">params</span> <span class="o">=</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">getParameterTypes</span><span class="p">();</span>
                <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// append the arguments to it so that each one is unique</span>
                    <span class="n">commandName</span> <span class="o">+=</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">params</span><span class="o">[</span><span class="n">k</span><span class="o">]</span><span class="p">.</span><span class="na">getSimpleName</span><span class="p">();</span>
                <span class="p">}</span>
 
                <span class="c1">// create the command info</span>
                <span class="n">CommandInfo</span> <span class="n">ci</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CommandInfo</span><span class="p">();</span>
                <span class="n">ci</span><span class="p">.</span><span class="na">alias</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="na">alias</span><span class="p">();</span>
                <span class="n">ci</span><span class="p">.</span><span class="na">argNames</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="na">args</span><span class="p">();</span>
                <span class="n">ci</span><span class="p">.</span><span class="na">argDescriptions</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="na">argDescriptions</span><span class="p">();</span>
                <span class="n">ci</span><span class="p">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="na">description</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="n">si</span><span class="p">.</span><span class="na">longDescription</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">ci</span><span class="p">.</span><span class="na">longDescription</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="na">description</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="n">ci</span><span class="p">.</span><span class="na">longDescription</span> <span class="o">=</span> <span class="n">si</span><span class="p">.</span><span class="na">longDescription</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="n">ci</span><span class="p">.</span><span class="na">method</span> <span class="o">=</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
 
                <span class="c1">// and add the command!</span>
                <span class="n">commands</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">commandName</span><span class="p">,</span> <span class="n">ci</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div><p>Note that here I am storing each command in a hashmap with a key that includes both the function name and it’s argument signature (since there can be multiple functions with the same name, but different argument signatures). I then store all the information about the function in a container class so I can get information about it later.</p><p>Note that after calling all of this, I have a list of all functions in my package that have been marked as user-callable at their definition. Nowhere did I have to explicitely define functions—if I want to change the description of a function, I change it at the definition of the function; if I want to add an extra user-callable function, I make sure that the class it exists in extends <code>Scriptable</code> then I add the <code>@Scriptinfo</code> annotation definition before the method definition, and I’m done!</p><p>In order to get this running properly, you’ll need a couple more things including actually parsing what the user types in and calling the appropriate method (I’ll put this into a separate post later), and the ScriptInfo annotation definition and CommandInfo container definitions, both of which are included below:</p><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="p">;</span>
 
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommandInfo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">alias</span><span class="p">;</span>
    <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argNames</span><span class="p">;</span>
    <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argDescriptions</span><span class="p">;</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">description</span><span class="p">;</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">longDescription</span><span class="p">;</span>
    <span class="kd">public</span> <span class="n">Method</span> <span class="n">method</span><span class="p">;</span>
<span class="p">}</span>
</pre></div><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="p">;</span>
 
<span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span>
<span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">METHOD</span><span class="p">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">ScriptInfo</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">alias</span><span class="p">();</span>
    <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">args</span><span class="p">()</span> <span class="k">default</span> <span class="p">{};</span>
    <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">argDescriptions</span><span class="p">()</span> <span class="k">default</span> <span class="p">{};</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">description</span><span class="p">();</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">longDescription</span><span class="p">()</span> <span class="k">default</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></article><footer><span>© 2020 Kenton Hamaluik</span></footer></body></html>